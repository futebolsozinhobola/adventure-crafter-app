<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventure Crafter Pro - Web Edition</title>
    <!-- Carregamento de Fontes e CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@700&family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos customizados e sistema de temas */
        body { font-family: 'Roboto', sans-serif; }
        h1, h2, h3, .font-title { font-family: 'Roboto Slab', serif; }
        
        /* Tema Escuro (Padrão) */
        :root {
            --bg-main: #0f172a; --bg-surface: #1e293b; --bg-surface-light: #334155;
            --text-main: #f8fafc; --text-muted: #94a3b8; --primary: #3b82f6;
            --primary-dark: #2563eb; --accent: #10b981; --danger: #ef4444;
            --warning: #0891b2; /* Cor META alterada para Ciano */
            --border-color: #334155;
        }
        
        /* Tema Claro (Cores Renovadas) */
        .light-theme {
            --bg-main: #f8fafc; /* Slate 50 */
            --bg-surface: #ffffff; /* White */
            --bg-surface-light: #f1f5f9; /* Slate 100 */
            --text-main: #1e293b; /* Slate 800 */
            --text-muted: #64748b; /* Slate 500 */
            --border-color: #e2e8f0; /* Slate 200 */
        }

        /* Aplicação dos temas e transições */
        body { background-color: var(--bg-main); color: var(--text-main); transition: background-color 0.3s, color 0.3s; }
        .card { background-color: var(--bg-surface); transition: background-color 0.3s; }
        .card-light { background-color: var(--bg-surface-light); transition: background-color 0.3s; }
        .text-muted { color: var(--text-muted); }
        .btn-primary { background-color: var(--primary); transition: background-color 0.2s; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-accent { background-color: var(--accent); transition: background-color 0.2s; }
        .btn-accent:hover { background-color: #059669; }
        .btn-danger { background-color: var(--danger); transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #dc2626; }
        .border-color { border-color: var(--border-color); }
        
        /* Foco e Animações */
        *:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: translateY(10px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        /* Estilos do Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-surface); }
        ::-webkit-scrollbar-thumb { background: var(--bg-surface-light); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Estilos para a navegação por abas */
        .tab-button.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Estilos para listas e painéis de edição */
        .item-list { max-height: 65vh; overflow-y: auto; }
        .item-list li.selected { background-color: var(--primary); color: white; }
        .editor-panel { display: none; }
        .editor-panel.active { display: block; animation: fadeIn 0.5s; }
    </style>
</head>
<body class="antialiased">

    <!-- === TELA DE CARREGAMENTO === -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex flex-col justify-center items-center">
        <svg class="animate-spin h-10 w-10 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p id="loading-status" class="text-white text-lg">Carregando dados...</p>
    </div>

    <!-- === CONTEÚDO PRINCIPAL (visível após carregamento) === -->
    <div id="app-container" class="max-w-7xl mx-auto p-4 opacity-0 transition-opacity duration-500">
        <!-- Cabeçalho -->
        <header class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-3xl font-title">Adventure Crafter</h1>
                <p class="text-muted">Web Edition v6.2 - Final</p>
            </div>
            <div class="flex items-center space-x-2">
                <button id="save-btn" class="px-3 py-2 text-sm font-medium text-white rounded-md btn-primary">Salvar</button>
                <label for="load-file" class="cursor-pointer px-3 py-2 text-sm font-medium text-white rounded-md btn-primary">Carregar</label>
                <input type="file" id="load-file" class="hidden" accept=".json">
                <button id="theme-switcher" class="p-2 rounded-md card-light" aria-label="Mudar tema">
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    <svg id="theme-icon-light" class="hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>
            </div>
        </header>

        <!-- Navegação por Abas -->
        <div id="tab-navigation" class="flex flex-wrap border-b border-color mb-6">
            <button data-tab="generator" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors active">Gerador</button>
            <button data-tab="characters" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors">Personagens</button>
            <button data-tab="plotlines" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors">Linhas de Enredo</button>
            <button data-tab="turning_points" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors">Pontos de Virada</button>
            <button data-tab="notes" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors">Anotações</button>
        </div>

        <!-- Conteúdo das Abas -->
        <main>
            <section id="generator-tab" class="tab-content active"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1 card p-6 rounded-lg shadow-md"><h2 class="text-xl font-title mb-4">Gerar Pontos de Enredo</h2><div class="space-y-4"><div><label for="theme-select" class="block text-sm font-medium text-muted mb-1">Tema</label><select id="theme-select" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary"></select></div><button id="generate-plot-point-btn" class="w-full py-3 rounded-md text-white font-semibold btn-accent shadow-lg transform hover:scale-105 transition-transform">Gerar</button></div></div><div id="result-display" class="lg:col-span-2 card p-6 rounded-lg shadow-md flex flex-col justify-center items-center text-center min-h-[200px] transition-colors duration-500"><div id="result-content"><h3 id="result-title" class="text-2xl font-title mb-2">Clique em 'Gerar' para começar</h3><p id="result-explanation" class="text-muted">Aguardando geração...</p></div></div></div></section>
            <section id="characters-tab" class="tab-content"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-title">Personagens</h2><button id="add-character-btn" class="px-4 py-2 rounded-md text-white font-semibold btn-accent">Novo Personagem</button></div><div id="character-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div></section>
            <section id="plotlines-tab" class="tab-content"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1 card p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h2 class="text-xl font-title">Linhas de Enredo</h2><button id="add-plotline-btn" class="px-3 py-1 text-sm rounded-md text-white btn-accent">+</button></div><ul id="plotline-list" class="item-list border border-color rounded-md"></ul></div><div id="plotline-editor-panel" class="md:col-span-2 card p-6 rounded-lg editor-panel"></div></div></section>
            <section id="turning_points-tab" class="tab-content"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1 card p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h2 class="text-xl font-title">Pontos de Virada</h2><button id="add-tp-btn" class="px-3 py-1 text-sm rounded-md text-white btn-accent">+</button></div><ul id="tp-list" class="item-list border border-color rounded-md"></ul></div><div id="tp-editor-panel" class="md:col-span-2 card p-6 rounded-lg editor-panel"></div></div></section>
            <section id="notes-tab" class="tab-content"><div class="card p-6 rounded-lg"><h2 class="text-xl font-title mb-4">Registro da Aventura</h2><textarea id="history-log" readonly class="w-full h-96 p-2 rounded-md card-light border-none font-mono text-sm"></textarea><div class="mt-4 flex justify-end space-x-2"><button id="export-notes-btn" class="px-4 py-2 rounded-md text-white btn-primary">Exportar</button><button id="clear-notes-btn" class="px-4 py-2 rounded-md text-white btn-danger">Limpar</button></div></div></section>
        </main>
    </div>
    
    <!-- === MODAL === -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
    <div id="modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 card w-11/12 md:w-2/3 lg:w-1/2 max-w-2xl rounded-lg shadow-2xl z-50 hidden">
        <div class="relative p-6 md:p-8">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-muted hover:text-main" aria-label="Fechar modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <div id="modal-content"></div>
        </div>
    </div>
    
    <!-- === TOAST (Notificações) === -->
    <div id="toast" class="fixed bottom-5 right-5 card-light py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none">
        <p id="toast-message" class="text-text-main"></p>
    </div>
    
    <!-- === SCRIPT PRINCIPAL === -->
    <script>
    (async function() {
        // --- Definições de Tipo (JSDoc) ---
        /** @typedef {{characters: Character[], plotlines: Plotline[], turning_points: TurningPoint[], theme: 'light'|'dark', history: string}} State */
        /** @typedef {{id: number, name: string, special_trait: string, emoji: string, identities: string[], descriptors: string[], notes: string}} Character */
        /** @typedef {{id: number, name: string, full_description: string, notes: string}} Plotline */
        /** @typedef {{id: number, title: string, plotlineId: number|null, status: string, plot_points: string[], invoked_characters: string[], notes: string}} TurningPoint */

        // --- Carregamento de Dados ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');

        async function fetchData(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Falha ao carregar ${url}: ${response.statusText}`);
            return await response.json();
        }

        let plotlinesData, charactersData, phrasesData;
        try {
            [plotlinesData, charactersData, phrasesData] = await Promise.all([
                fetchData('plotlines.json'), fetchData('characters.json'), fetchData('phrases.json')
            ]);
        } catch (error) {
            document.getElementById('loading-status').textContent = `Erro: ${error.message}. Verifique o console.`;
            return;
        }
        
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
            appContainer.style.opacity = '1';
        }, 500);

        // --- Estado da Aplicação ---
        /** @type {State} */
        let state = {
            characters: [], plotlines: [], turning_points: [], theme: 'dark', history: ''
        };
        let activeSelections = {
            plotlineId: null,
            tpId: null,
        };

        // --- Utilitários e Geradores ---
        const THEME_COLORS = { action: "#dc2626", tension: "#ea580c", mystery: "#7c3aed", social: "#be185d", personal: "#059669", meta: "#0891b2", default: "#475569" };
        const THEME_EMOJIS = { action: "💥", tension: "⏳", mystery: "❓", social: "💬", personal: "❤️", meta: "⚙️", default: "🎲" };

        class CycledShuffler {
            constructor(items) { this._original = [...items]; this._shuffled = []; this._fill(); }
            _fill() { this._shuffled = [...this._original].sort(() => Math.random() - 0.5); }
            next() { if (this._shuffled.length === 0) this._fill(); return this._shuffled.pop(); }
        }

        const shufflers = {};
        function initializeShufflers() {
            shufflers.plotlines = {};
            for (const theme in plotlinesData) shufflers.plotlines[theme] = {
                goals: new CycledShuffler(plotlinesData[theme].goals),
                subjects: new CycledShuffler(plotlinesData[theme].subjects),
                focuses: new CycledShuffler(plotlinesData[theme].focuses)
            };
            shufflers.characters = {
                identities: new CycledShuffler(charactersData.identities),
                descriptors: new CycledShuffler(charactersData.descriptors),
                name_parts: {}
            };
            for (const theme in charactersData.name_parts) shufflers.characters.name_parts[theme] = [
                new CycledShuffler(charactersData.name_parts[theme][0]),
                new CycledShuffler(charactersData.name_parts[theme][1])
            ];
        }
        
        const rollDie = (sides) => Math.floor(Math.random() * sides) + 1;
        const getPhraseByRoll = (table, roll) => table.find(item => roll >= item.range[0] && roll <= item.range[1]) || null;
        const showToast = (message) => {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        };
        const logEvent = (message) => {
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            state.history += `[${timestamp}] ${message}\n`;
            renderHistory();
        };

        // --- Renderização (UI) ---
        const DOM = {
            characterList: document.getElementById('character-list'),
            plotlineList: document.getElementById('plotline-list'),
            tpList: document.getElementById('tp-list'),
            plotlineEditor: document.getElementById('plotline-editor-panel'),
            tpEditor: document.getElementById('tp-editor-panel'),
            historyLog: document.getElementById('history-log'),
       
