<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventure Crafter Pro - Web Edition</title>
    <!-- Carregamento de Fontes e CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos customizados e sistema de temas */
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, .font-title { font-family: 'Poppins', sans-serif; }
        
        /* Tema Escuro (Padrão) */
        :root {
            --bg-main: #0f172a; --bg-surface: #1e293b; --bg-surface-light: #334155;
            --text-main: #f8fafc; --text-muted: #94a3b8; --primary: #3b82f6;
            --primary-dark: #2563eb; --accent: #10b981; --danger: #ef4444;
            --border-color: #334155;
        }
        
        /* Tema Claro */
        .light-theme {
            --bg-main: #f1f5f9; --bg-surface: #ffffff; --bg-surface-light: #e2e8f0;
            --text-main: #0f172a; --text-muted: #475569;
            --border-color: #cbd5e1;
        }

        /* Aplicação dos temas e transições */
        body { background-color: var(--bg-main); color: var(--text-main); transition: background-color 0.3s, color 0.3s; }
        .card { background-color: var(--bg-surface); transition: background-color 0.3s; }
        .card-light { background-color: var(--bg-surface-light); transition: background-color 0.3s; }
        .text-muted { color: var(--text-muted); }
        .btn-primary { background-color: var(--primary); transition: background-color 0.2s; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-accent { background-color: var(--accent); transition: background-color 0.2s; }
        .btn-accent:hover { background-color: #059669; }
        .btn-danger { background-color: var(--danger); transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #dc2626; }
        .border-color { border-color: var(--border-color); }
        
        /* Foco e Animações */
        *:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: translateY(10px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        /* Estilos do Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-surface); }
        ::-webkit-scrollbar-thumb { background: var(--bg-surface-light); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Estilos para a navegação por abas */
        .tab-button.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Estilos para listas e painéis de edição */
        .item-list { max-height: 65vh; overflow-y: auto; }
        .item-list li.selected { background-color: var(--primary); }
        .editor-panel { display: none; }
        .editor-panel.active { display: block; animation: fadeIn 0.5s; }
    </style>
</head>
<body class="antialiased">

    <!-- === TELA DE CARREGAMENTO === -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex flex-col justify-center items-center">
        <svg class="animate-spin h-10 w-10 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p id="loading-status" class="text-white text-lg">Carregando dados...</p>
    </div>

    <!-- === CONTEÚDO PRINCIPAL (visível após carregamento) === -->
    <div id="app-container" class="max-w-7xl mx-auto p-4 opacity-0 transition-opacity duration-500">
        <!-- Cabeçalho -->
        <header class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-3xl font-title">Adventure Crafter</h1>
                <p class="text-muted">Web Edition v3.0</p>
            </div>
            <div class="flex items-center space-x-2">
                <button id="save-btn" class="px-3 py-2 text-sm font-medium text-white rounded-md btn-primary">Salvar</button>
                <label for="load-file" class="cursor-pointer px-3 py-2 text-sm font-medium text-white rounded-md btn-primary">Carregar</label>
                <input type="file" id="load-file" class="hidden" accept=".json">
                <button id="theme-switcher" class="p-2 rounded-md card-light" aria-label="Mudar tema">
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    <svg id="theme-icon-light" class="hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>
            </div>
        </header>

        <!-- Navegação por Abas -->
        <div id="tab-navigation" class="flex flex-wrap border-b border-color mb-6">
            <button data-tab="generator" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors active">Gerador</button>
            <button data-tab="characters" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors">Personagens</button>
            <button data-tab="plotlines" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors">Linhas de Enredo</button>
            <button data-tab="turning_points" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors">Pontos de Virada</button>
        </div>

        <!-- Conteúdo das Abas -->
        <main>
            <!-- Seção: Gerador -->
            <section id="generator-tab" class="tab-content active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 card p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-title mb-4">Gerar Pontos de Enredo</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="theme-select" class="block text-sm font-medium text-muted mb-1">Tema</label>
                                <select id="theme-select" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary"></select>
                            </div>
                            <button id="generate-plot-point-btn" class="w-full py-3 rounded-md text-white font-semibold btn-accent shadow-lg transform hover:scale-105 transition-transform">Gerar</button>
                        </div>
                    </div>
                    <div id="result-display" class="lg:col-span-2 card p-6 rounded-lg shadow-md flex flex-col justify-center items-center text-center min-h-[200px]">
                        <h3 id="result-title" class="text-2xl font-title mb-2">Clique em 'Gerar' para começar</h3>
                        <p id="result-explanation" class="text-muted">Aguardando geração...</p>
                    </div>
                </section>
            </section>

            <!-- Seção: Personagens -->
            <section id="characters-tab" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-title">Personagens</h2>
                    <button id="add-character-btn" class="px-4 py-2 rounded-md text-white font-semibold btn-accent">Novo Personagem</button>
                </div>
                <div id="character-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            </section>

            <!-- Seção: Linhas de Enredo -->
            <section id="plotlines-tab" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Painel da Lista -->
                    <div class="md:col-span-1 card p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-xl font-title">Linhas de Enredo</h2>
                            <button id="add-plotline-btn" class="px-3 py-1 text-sm rounded-md text-white btn-accent">+</button>
                        </div>
                        <ul id="plotline-list" class="item-list border border-color rounded-md"></ul>
                    </div>
                    <!-- Painel do Editor -->
                    <div id="plotline-editor-panel" class="md:col-span-2 card p-6 rounded-lg editor-panel">
                        <h3 class="text-xl font-title mb-4">Editor de Linha de Enredo</h3>
                        <div>
                            <label for="plot-name-input" class="block text-sm font-medium text-muted mb-1">Nome Curto</label>
                            <input type="text" id="plot-name-input" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-muted mb-1">Descrição Completa</label>
                            <p id="plot-fulldesc-display" class="p-4 rounded-md card-light min-h-[60px]"></p>
                        </div>
                        <div class="mt-4">
                            <label for="plot-notes-input" class="block text-sm font-medium text-muted mb-1">Anotações</label>
                            <textarea id="plot-notes-input" rows="5" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary"></textarea>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="delete-plotline-btn" class="px-4 py-2 rounded-md text-white btn-danger">Remover</button>
                            <button id="save-plotline-btn" class="px-4 py-2 rounded-md text-white btn-primary">Salvar</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Seção: Pontos de Virada -->
            <section id="turning_points-tab" class="tab-content">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Painel da Lista -->
                    <div class="md:col-span-1 card p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-xl font-title">Pontos de Virada</h2>
                            <button id="add-tp-btn" class="px-3 py-1 text-sm rounded-md text-white btn-accent">+</button>
                        </div>
                        <ul id="tp-list" class="item-list border border-color rounded-md"></ul>
                    </div>
                    <!-- Painel do Editor -->
                    <div id="tp-editor-panel" class="md:col-span-2 card p-6 rounded-lg editor-panel">
                        <h3 class="text-xl font-title mb-4">Editor de Ponto de Virada</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="tp-title-input" class="block text-sm font-medium text-muted mb-1">Título</label>
                                <input type="text" id="tp-title-input" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="tp-plotline-select" class="block text-sm font-medium text-muted mb-1">Linha de Enredo Associada</label>
                                    <select id="tp-plotline-select" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-muted mb-1">Status do Enredo</label>
                                    <div class="flex space-x-4 p-2">
                                       <label><input type="radio" name="tp-status" value="Nova" class="text-primary focus:ring-primary"> Nova</label>
                                       <label><input type="radio" name="tp-status" value="Desenvolvimento" class="text-primary focus:ring-primary"> Em Andamento</label>
                                       <label><input type="radio" name="tp-status" value="Conclusão" class="text-primary focus:ring-primary"> Conclusão</label>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-muted">Pontos de Trama</label>
                                    <input type="text" class="tp-plot-point-input w-full p-2 rounded-md card-light border-none text-sm" placeholder="1. ...">
                                    <input type="text" class="tp-plot-point-input w-full p-2 rounded-md card-light border-none text-sm" placeholder="2. ...">
                                    <input type="text" class="tp-plot-point-input w-full p-2 rounded-md card-light border-none text-sm" placeholder="3. ...">
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-muted">Personagens Invocados</label>
                                    <input type="text" class="tp-char-input w-full p-2 rounded-md card-light border-none text-sm" placeholder="1. ...">
                                    <input type="text" class="tp-char-input w-full p-2 rounded-md card-light border-none text-sm" placeholder="2. ...">
                                    <input type="text" class="tp-char-input w-full p-2 rounded-md card-light border-none text-sm" placeholder="3. ...">
                                </div>
                            </div>
                            <div>
                                <label for="tp-notes-input" class="block text-sm font-medium text-muted mb-1">Anotações</label>
                                <textarea id="tp-notes-input" rows="4" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary"></textarea>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-2">
                            <button id="delete-tp-btn" class="px-4 py-2 rounded-md text-white btn-danger">Remover</button>
                            <button id="save-tp-btn" class="px-4 py-2 rounded-md text-white btn-primary">Salvar</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- === MODAL === -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
    <div id="modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 card w-11/12 md:w-2/3 lg:w-1/2 max-w-2xl rounded-lg shadow-2xl z-50 hidden">
        <div class="relative p-6 md:p-8">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-muted hover:text-main" aria-label="Fechar modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <div id="modal-content"></div>
        </div>
    </div>
    
    <!-- === TOAST (Notificações) === -->
    <div id="toast" class="fixed bottom-5 right-5 card-light py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none">
        <p id="toast-message" class="text-text-main"></p>
    </div>
    
    <!-- === SCRIPT PRINCIPAL === -->
    <script>
    // IIFE para encapsular o escopo e usar async/await no nível superior
    (async function() {
        // --- Definições de Tipo (JSDoc) ---
        /** @typedef {{characters: Character[], plotlines: Plotline[], turning_points: TurningPoint[], theme: 'light'|'dark'}} State */
        /** @typedef {{id: number, name: string, special_trait: string, emoji: string, identities: string[], descriptors: string[], notes: string}} Character */
        /** @typedef {{id: number, name: string, full_description: string, notes: string}} Plotline */
        /** @typedef {{id: number, title: string, plotlineId: number|null, status: string, plot_points: string[], invoked_characters: string[], notes: string}} TurningPoint */

        // --- Carregamento de Dados ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');

        async function fetchData(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Falha ao carregar ${url}: ${response.statusText}`);
            return await response.json();
        }

        let plotlinesData, charactersData, phrasesData;
        try {
            [plotlinesData, charactersData, phrasesData] = await Promise.all([
                fetchData('plotlines.json'), fetchData('characters.json'), fetchData('phrases.json')
            ]);
        } catch (error) {
            document.getElementById('loading-status').textContent = `Erro: ${error.message}. Verifique o console.`;
            return;
        }
        
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
            appContainer.style.opacity = '1';
        }, 500);

        // --- Estado da Aplicação ---
        /** @type {State} */
        let state = {
            characters: [], plotlines: [], turning_points: [], theme: 'dark'
        };
        let activeSelections = {
            plotlineId: null,
            tpId: null,
        };

        // --- Utilitários e Geradores ---
        class CycledShuffler {
            constructor(items) { this._original = [...items]; this._shuffled = []; this._fill(); }
            _fill() { this._shuffled = [...this._original].sort(() => Math.random() - 0.5); }
            next() { if (this._shuffled.length === 0) this._fill(); return this._shuffled.pop(); }
        }

        const shufflers = {};
        function initializeShufflers() {
            shufflers.plotlines = {};
            for (const theme in plotlinesData) shufflers.plotlines[theme] = {
                goals: new CycledShuffler(plotlinesData[theme].goals),
                subjects: new CycledShuffler(plotlinesData[theme].subjects),
                focuses: new CycledShuffler(plotlinesData[theme].focuses)
            };
            shufflers.characters = {
                identities: new CycledShuffler(charactersData.identities),
                descriptors: new CycledShuffler(charactersData.descriptors),
                name_parts: {}
            };
            for (const theme in charactersData.name_parts) shufflers.characters.name_parts[theme] = [
                new CycledShuffler(charactersData.name_parts[theme][0]),
                new CycledShuffler(charactersData.name_parts[theme][1])
            ];
        }
        
        const rollDie = (sides) => Math.floor(Math.random() * sides) + 1;
        const rollOnTable = (table, roll) => table.find(item => roll >= item.range[0] && roll <= item.range[1])?.value || null;
        const showToast = (message) => {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        };

        // --- Renderização (UI) ---
        const DOM = {
            characterList: document.getElementById('character-list'),
            plotlineList: document.getElementById('plotline-list'),
            tpList: document.getElementById('tp-list'),
            plotlineEditor: document.getElementById('plotline-editor-panel'),
            tpEditor: document.getElementById('tp-editor-panel'),
        };

        const renderAll = () => {
            renderCharacters();
            renderPlotlines();
            renderTurningPoints();
            renderPlotlineEditor();
            renderTPEditor();
        };

        function renderCharacters() {
            DOM.characterList.innerHTML = state.characters.length === 0
                ? `<p class="text-muted col-span-full text-center p-8">Nenhum personagem criado.</p>`
                : state.characters.map(char => `
                    <div class="card p-4 rounded-lg shadow-md flex flex-col justify-between fade-in">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-title text-lg mb-1">${char.emoji} ${char.name}</h3>
                                <button class="delete-btn text-xs text-red-400 hover:text-red-600" data-type="character" data-id="${char.id}">X</button>
                            </div>
                            <p class="text-sm text-muted font-semibold">${char.special_trait}</p>
                            <p class="text-sm text-muted"><b>ID:</b> ${char.identities.join(', ')}</p>
                            <p class="text-sm text-muted"><b>Desc:</b> ${char.descriptors.join(', ')}</p>
                            <textarea class="w-full card-light p-2 mt-2 rounded-md text-sm border-none focus:ring-2 focus:ring-primary" placeholder="Anotações..." data-id="${char.id}" data-type="character" data-prop="notes">${char.notes}</textarea>
                        </div>
                    </div>
                `).join('');
        }

        function renderPlotlines() {
            DOM.plotlineList.innerHTML = state.plotlines.length === 0
                ? `<li class="p-4 text-center text-muted">Nenhum enredo.</li>`
                : state.plotlines.map(plot => `
                    <li class="p-3 cursor-pointer border-b border-color last:border-b-0 hover:bg-surface-light transition-colors ${plot.id === activeSelections.plotlineId ? 'selected' : ''}" data-id="${plot.id}">
                        ${plot.name}
                    </li>
                `).join('');
        }

        function renderTurningPoints() {
            DOM.tpList.innerHTML = state.turning_points.length === 0
                ? `<li class="p-4 text-center text-muted">Nenhum ponto de virada.</li>`
                : state.turning_points.map(tp => `
                    <li class="p-3 cursor-pointer border-b border-color last:border-b-0 hover:bg-surface-light transition-colors ${tp.id === activeSelections.tpId ? 'selected' : ''}" data-id="${tp.id}">
                        ${tp.title}
                    </li>
                `).join('');
        }
        
        function renderPlotlineEditor() {
            const editor = DOM.plotlineEditor;
            const plot = state.plotlines.find(p => p.id === activeSelections.plotlineId);
            if (!plot) {
                editor.classList.remove('active');
                return;
            }
            editor.querySelector('#plot-name-input').value = plot.name;
            editor.querySelector('#plot-fulldesc-display').textContent = plot.full_description;
            editor.querySelector('#plot-notes-input').value = plot.notes;
            editor.classList.add('active');
        }

        function renderTPEditor() {
            const editor = DOM.tpEditor;
            const tp = state.turning_points.find(t => t.id === activeSelections.tpId);
            if (!tp) {
                editor.classList.remove('active');
                return;
            }
            editor.querySelector('#tp-title-input').value = tp.title;
            const plotlineSelect = editor.querySelector('#tp-plotline-select');
            plotlineSelect.innerHTML = '<option value="">Nenhuma</option>' + state.plotlines.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            plotlineSelect.value = tp.plotlineId || "";
            editor.querySelector(`input[name="tp-status"][value="${tp.status}"]`).checked = true;
            editor.querySelectorAll('.tp-plot-point-input').forEach((input, i) => input.value = tp.plot_points[i] || '');
            editor.querySelectorAll('.tp-char-input').forEach((input, i) => input.value = tp.invoked_characters[i] || '');
            editor.querySelector('#tp-notes-input').value = tp.notes;
            editor.classList.add('active');
        }

        // --- Lógica dos Modais e Geradores ---
        const modal = {
            content: document.getElementById('modal-content'),
            backdrop: document.getElementById('modal-backdrop'),
            container: document.getElementById('modal'),
            open(html) {
                this.content.innerHTML = html;
                this.backdrop.classList.remove('hidden');
                this.container.classList.remove('hidden');
            },
            close() {
                this.container.classList.add('hidden');
                this.backdrop.classList.add('hidden');
                this.content.innerHTML = '';
            }
        };

        function showCharacterGenerator() {
            const nameThemes = Object.keys(charactersData.name_parts).map(t => `<option value="${t}">${t}</option>`).join('');
            modal.open(`
                <h2 class="font-title text-2xl mb-6 text-center">Gerador de Personagem</h2>
                <div class="space-y-4">
                    <div>
                        <label for="char-name-theme" class="block text-sm font-medium text-muted mb-1">Tema do Nome</label>
                        <select id="char-name-theme" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary">${nameThemes}</select>
                    </div>
                    <button id="generate-char-name-btn" class="w-full py-2 rounded-md text-white font-semibold btn-primary">Gerar Nome</button>
                    <input type="text" id="char-name-input" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary" placeholder="Nome do Personagem">
                </div>
                <div class="flex justify-end space-x-3 mt-8">
                    <button id="cancel-modal-btn" class="px-4 py-2 rounded-md card-light">Cancelar</button>
                    <button id="confirm-add-char-btn" class="px-4 py-2 rounded-md text-white btn-accent">Adicionar Personagem</button>
                </div>
            `);
            
            document.getElementById('generate-char-name-btn').onclick = () => {
                const theme = document.getElementById('char-name-theme').value;
                const [firstNameShuffler, lastNameShuffler] = shufflers.characters.name_parts[theme];
                let name = `${firstNameShuffler.next()} ${lastNameShuffler.next()}`;
                if (theme === "Ficção Científica" && rollDie(100) <= 20) name = `${firstNameShuffler.next()}${lastNameShuffler.next()}-${rollDie(899) + 100}`;
                document.getElementById('char-name-input').value = name;
            };

            document.getElementById('confirm-add-char-btn').onclick = () => {
                const name = document.getElementById('char-name-input').value;
                if (!name) { showToast('Por favor, insira um nome.'); return; }
                const [special_trait, emoji] = rollOnTable(charactersData.special_characteristics, rollDie(100));
                const identities = Array.from({ length: rollDie(100) <= 33 ? 2 : 1 }, () => shufflers.characters.identities.next());
                const descriptors = Array.from({ length: rollDie(100) <= 21 ? 2 : 1 }, () => shufflers.characters.descriptors.next());
                const newChar = { id: Date.now(), name, special_trait, emoji, identities, descriptors, notes: '' };
                state.characters.push(newChar);
                renderCharacters();
                modal.close();
                showToast(`Personagem "${name}" adicionado!`);
            };
            document.getElementById('cancel-modal-btn').onclick = modal.close;
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            // Navegação por Abas
            document.getElementById('tab-navigation').addEventListener('click', (e) => {
                if (e.target.matches('.tab-button')) {
                    const tabId = e.target.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                }
            });

            // Gerador Principal
            document.getElementById('generate-plot-point-btn').addEventListener('click', () => {
                let theme = document.getElementById('theme-select').value;
                let roll = rollDie(100);
                let phraseData = rollOnTable(phrasesData[theme], roll);
                if (phraseData && phraseData.title === "META") {
                    theme = 'meta';
                    roll = rollDie(100);
                    phraseData = rollOnTable(phrasesData[theme], roll);
                }
                const resultDisplay = document.getElementById('result-display');
                resultDisplay.classList.remove('fade-in');
                void resultDisplay.offsetWidth;
                resultDisplay.classList.add('fade-in');
                document.getElementById('result-title').textContent = phraseData.title;
                document.getElementById('result-explanation').textContent = phraseData.desc;
            });
            
            // Botões de Adicionar
            document.getElementById('add-character-btn').addEventListener('click', showCharacterGenerator);
            // ... (adicionar listeners para outros botões de "add")

            // Seleção e Edição
            DOM.plotlineList.addEventListener('click', (e) => {
                if (e.target.matches('li')) {
                    activeSelections.plotlineId = parseInt(e.target.dataset.id);
                    renderPlotlines();
                    renderPlotlineEditor();
                }
            });
            DOM.tpList.addEventListener('click', (e) => {
                if (e.target.matches('li')) {
                    activeSelections.tpId = parseInt(e.target.dataset.id);
                    renderTurningPoints();
                    renderTPEditor();
                }
            });

            // Salvar Editores
            document.getElementById('save-plotline-btn').addEventListener('click', () => {
                const plot = state.plotlines.find(p => p.id === activeSelections.plotlineId);
                if (!plot) return;
                plot.name = document.getElementById('plot-name-input').value;
                plot.notes = document.getElementById('plot-notes-input').value;
                renderPlotlines();
                showToast("Linha de enredo salva!");
            });
            // ... (adicionar listener para salvar TP)

            // Deleção
            document.getElementById('app-container').addEventListener('click', (e) => {
                if (e.target.matches('.delete-btn')) {
                    const id = parseInt(e.target.dataset.id);
                    const type = e.target.dataset.type;
                    if (type === 'character') state.characters = state.characters.filter(i => i.id !== id);
                    // ... (adicionar lógica para deletar outros tipos)
                    renderAll();
                }
            });
            
            // Salvar/Carregar
            document.getElementById('save-btn').addEventListener('click', () => {
                const dataStr = JSON.stringify(state, null, 2);
                const link = document.createElement('a');
                link.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                link.download = `adventure-crafter-${new Date().toISOString().slice(0,10)}.json`;
                link.click();
            });
            document.getElementById('load-file').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const loaded = JSON.parse(ev.target.result);
                        if ('characters' in loaded && 'plotlines' in loaded && 'turning_points' in loaded) {
                            state = loaded;
                            initializeShufflers();
                            renderAll();
                            showToast("Aventura carregada!");
                        } else throw new Error("Formato de arquivo inválido.");
                    } catch (err) { showToast(`Erro ao carregar: ${err.message}`); }
                };
                reader.readAsText(file);
                e.target.value = '';
            });

            // Modal
            document.getElementById('modal-close-btn').addEventListener('click', modal.close);
            modal.backdrop.addEventListener('click', modal.close);
        }

        // --- Inicialização da Aplicação ---
        function init() {
            const themeSelect = document.getElementById('theme-select');
            themeSelect.innerHTML = Object.keys(phrasesData).map(t => `<option value="${t}">${t.charAt(0).toUpperCase() + t.slice(1)}</option>`).join('');
            
            initializeShufflers();
            setupEventListeners();
            renderAll();
        }

        init();
    })();
    </script>
</body>
</html>
