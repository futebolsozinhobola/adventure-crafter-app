<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventure Crafter Pro - Web Edition</title>
    <!-- Carregamento de Fontes e CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@700&family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos customizados e sistema de temas */
        body { font-family: 'Roboto', sans-serif; }
        h1, h2, h3, .font-title { font-family: 'Roboto Slab', serif; }
        
        /* Tema Escuro (Padrão) */
        :root {
            --bg-main: #0f172a; --bg-surface: #1e293b; --bg-surface-light: #334155;
            --text-main: #f8fafc; --text-muted: #94a3b8; --primary: #3b82f6;
            --primary-dark: #2563eb; --accent: #10b981; --danger: #ef4444;
            --warning: #0891b2; /* Cor META alterada para Ciano */
            --border-color: #334155;
        }
        
        /* Tema Claro (Cores Renovadas) */
        .light-theme {
            --bg-main: #f8fafc; --bg-surface: #ffffff; --bg-surface-light: #f1f5f9;
            --text-main: #1e293b; --text-muted: #64748b;
            --border-color: #e2e8f0;
        }

        /* Aplicação dos temas e transições */
        body { background-color: var(--bg-main); color: var(--text-main); transition: background-color 0.3s, color 0.3s; }
        .card { background-color: var(--bg-surface); transition: background-color 0.3s; }
        .card-light { background-color: var(--bg-surface-light); transition: background-color 0.3s; }
        .text-muted { color: var(--text-muted); }
        .btn-primary { background-color: var(--primary); transition: background-color 0.2s; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-accent { background-color: var(--accent); transition: background-color 0.2s; }
        .btn-accent:hover { background-color: #059669; }
        .btn-danger { background-color: var(--danger); transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #dc2626; }
        .border-color { border-color: var(--border-color); }
        
        /* Foco e Animações */
        *:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { transform: translateY(10px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        /* Estilos do Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-surface); }
        ::-webkit-scrollbar-thumb { background: var(--bg-surface-light); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Estilos para a navegação por abas */
        .tab-button.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Estilos para listas e painéis de edição */
        .item-list { max-height: 65vh; overflow-y: auto; }
        .item-list li.selected { background-color: var(--primary); color: white; }
        .editor-panel { display: none; }
        .editor-panel.active { display: block; animation: fadeIn 0.5s; }
    </style>
</head>
<body class="antialiased">

    <!-- === TELA DE CARREGAMENTO === -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex flex-col justify-center items-center">
        <svg class="animate-spin h-10 w-10 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p id="loading-status" class="text-white text-lg">Carregando dados...</p>
    </div>

    <!-- === CONTEÚDO PRINCIPAL (visível após carregamento) === -->
    <div id="app-container" class="max-w-7xl mx-auto p-4 opacity-0 transition-opacity duration-500">
        <!-- Cabeçalho -->
        <header class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-3xl font-title">Adventure Crafter</h1>
                <p class="text-muted">Web Edition v6.2 - Final</p>
            </div>
            <div class="flex items-center space-x-2">
                <button id="save-btn" class="px-3 py-2 text-sm font-medium text-white rounded-md btn-primary">Salvar</button>
                <label for="load-file" class="cursor-pointer px-3 py-2 text-sm font-medium text-white rounded-md btn-primary">Carregar</label>
                <input type="file" id="load-file" class="hidden" accept=".json">
                <button id="theme-switcher" class="p-2 rounded-md card-light" aria-label="Mudar tema">
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    <svg id="theme-icon-light" class="hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>
            </div>
        </header>

        <!-- Navegação por Abas -->
        <div id="tab-navigation" class="flex flex-wrap border-b border-color mb-6">
            <button data-tab="generator" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors active">Gerador</button>
            <button data-tab="characters" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors">Personagens</button>
            <button data-tab="plotlines" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors">Linhas de Enredo</button>
            <button data-tab="turning_points" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors">Pontos de Virada</button>
            <button data-tab="notes" class="tab-button px-4 py-3 font-semibold border-b-2 transition-colors">Anotações</button>
        </div>

        <!-- Conteúdo das Abas -->
        <main>
            <section id="generator-tab" class="tab-content active"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1 card p-6 rounded-lg shadow-md"><h2 class="text-xl font-title mb-4">Gerar Pontos de Enredo</h2><div class="space-y-4"><div><label for="theme-select" class="block text-sm font-medium text-muted mb-1">Tema</label><select id="theme-select" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary"></select></div><button id="generate-plot-point-btn" class="w-full py-3 rounded-md text-white font-semibold btn-accent shadow-lg transform hover:scale-105 transition-transform">Gerar</button></div></div><div id="result-display" class="lg:col-span-2 card p-6 rounded-lg shadow-md flex flex-col justify-center items-center text-center min-h-[200px] transition-colors duration-500"><div id="result-content"><h3 id="result-title" class="text-2xl font-title mb-2">Clique em 'Gerar' para começar</h3><p id="result-explanation" class="text-muted">Aguardando geração...</p></div></div></div></section>
            <section id="characters-tab" class="tab-content"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-title">Personagens</h2><button id="add-character-btn" class="px-4 py-2 rounded-md text-white font-semibold btn-accent">Novo Personagem</button></div><div id="character-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div></section>
            <section id="plotlines-tab" class="tab-content"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1 card p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h2 class="text-xl font-title">Linhas de Enredo</h2><button id="add-plotline-btn" class="px-3 py-1 text-sm rounded-md text-white btn-accent">+</button></div><ul id="plotline-list" class="item-list border border-color rounded-md"></ul></div><div id="plotline-editor-panel" class="md:col-span-2 card p-6 rounded-lg editor-panel"></div></div></section>
            <section id="turning_points-tab" class="tab-content"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1 card p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h2 class="text-xl font-title">Pontos de Virada</h2><button id="add-tp-btn" class="px-3 py-1 text-sm rounded-md text-white btn-accent">+</button></div><ul id="tp-list" class="item-list border border-color rounded-md"></ul></div><div id="tp-editor-panel" class="md:col-span-2 card p-6 rounded-lg editor-panel"></div></div></section>
            <section id="notes-tab" class="tab-content"><div class="card p-6 rounded-lg"><h2 class="text-xl font-title mb-4">Registro da Aventura</h2><textarea id="history-log" readonly class="w-full h-96 p-2 rounded-md card-light border-none font-mono text-sm"></textarea><div class="mt-4 flex justify-end space-x-2"><button id="export-notes-btn" class="px-4 py-2 rounded-md text-white btn-primary">Exportar</button><button id="clear-notes-btn" class="px-4 py-2 rounded-md text-white btn-danger">Limpar</button></div></div></section>
        </main>
    </div>
    
    <!-- === MODAL === -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden"></div>
    <div id="modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 card w-11/12 md:w-2/3 lg:w-1/2 max-w-2xl rounded-lg shadow-2xl z-50 hidden">
        <div class="relative p-6 md:p-8">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-muted hover:text-main" aria-label="Fechar modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <div id="modal-content"></div>
        </div>
    </div>
    
    <!-- === TOAST (Notificações) === -->
    <div id="toast" class="fixed bottom-5 right-5 card-light py-3 px-5 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none">
        <p id="toast-message" class="text-text-main"></p>
    </div>
    
    <!-- === SCRIPT PRINCIPAL === -->
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- Definições de Tipo (JSDoc) ---
        /** @typedef {{characters: Character[], plotlines: Plotline[], turning_points: TurningPoint[], theme: 'light'|'dark', history: string}} State */
        /** @typedef {{id: number, name: string, special_trait: string, emoji: string, identities: string[], descriptors: string[], notes: string}} Character */
        /** @typedef {{id: number, name: string, full_description: string, notes: string}} Plotline */
        /** @typedef {{id: number, title: string, plotlineId: number|null, status: string, plot_points: string[], invoked_characters: string[], notes: string}} TurningPoint */

        // --- Carregamento de Dados ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const appContainer = document.getElementById('app-container');

        async function fetchData(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Falha ao carregar ${url}: ${response.statusText}`);
            return await response.json();
        }

        let plotlinesData, charactersData, phrasesData;
        try {
            [plotlinesData, charactersData, phrasesData] = await Promise.all([
                fetchData('plotlines.json'), fetchData('characters.json'), fetchData('phrases.json')
            ]);
        } catch (error) {
            document.getElementById('loading-status').textContent = `Erro: ${error.message}. Verifique o console.`;
            return;
        }
        
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
            appContainer.style.opacity = '1';
        }, 500);

        // --- Estado da Aplicação ---
        /** @type {State} */
        let state = {
            characters: [], plotlines: [], turning_points: [], theme: 'dark', history: ''
        };
        let activeSelections = {
            plotlineId: null,
            tpId: null,
        };

        // --- Utilitários e Geradores ---
        const THEME_COLORS = { action: "#dc2626", tension: "#ea580c", mystery: "#7c3aed", social: "#be185d", personal: "#059669", meta: "#0891b2", default: "#475569" };
        const THEME_EMOJIS = { action: "💥", tension: "⏳", mystery: "❓", social: "💬", personal: "❤️", meta: "⚙️", default: "🎲" };

        class CycledShuffler {
            constructor(items) { this._original = [...items]; this._shuffled = []; this._fill(); }
            _fill() { this._shuffled = [...this._original].sort(() => Math.random() - 0.5); }
            next() { if (this._shuffled.length === 0) this._fill(); return this._shuffled.pop(); }
        }

        const shufflers = {};
        function initializeShufflers() {
            shufflers.plotlines = {};
            for (const theme in plotlinesData) shufflers.plotlines[theme] = {
                goals: new CycledShuffler(plotlinesData[theme].goals),
                subjects: new CycledShuffler(plotlinesData[theme].subjects),
                focuses: new CycledShuffler(plotlinesData[theme].focuses)
            };
            shufflers.characters = {
                identities: new CycledShuffler(charactersData.identities),
                descriptors: new CycledShuffler(charactersData.descriptors),
                name_parts: {}
            };
            for (const theme in charactersData.name_parts) shufflers.characters.name_parts[theme] = [
                new CycledShuffler(charactersData.name_parts[theme][0]),
                new CycledShuffler(charactersData.name_parts[theme][1])
            ];
        }
        
        const rollDie = (sides) => Math.floor(Math.random() * sides) + 1;
        const getPhraseByRoll = (table, roll) => table.find(item => roll >= item.range[0] && roll <= item.range[1]) || null;
        const showToast = (message) => {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        };
        const logEvent = (message) => {
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            state.history += `[${timestamp}] ${message}\n`;
            renderHistory();
        };

        // --- Renderização (UI) ---
        const DOM = {
            characterList: document.getElementById('character-list'),
            plotlineList: document.getElementById('plotline-list'),
            tpList: document.getElementById('tp-list'),
            plotlineEditor: document.getElementById('plotline-editor-panel'),
            tpEditor: document.getElementById('tp-editor-panel'),
            historyLog: document.getElementById('history-log'),
        };

        const renderAll = () => {
            renderCharacters();
            renderPlotlines();
            renderTurningPoints();
            renderPlotlineEditor();
            renderTPEditor();
            renderHistory();
        };

        function renderCharacters() {
            DOM.characterList.innerHTML = state.characters.length === 0
                ? `<p class="text-muted col-span-full text-center p-8">Nenhum personagem criado.</p>`
                : state.characters.map(char => `
                    <div class="card p-4 rounded-lg shadow-md flex flex-col justify-between fade-in">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-title text-lg mb-1">${char.emoji} ${char.name}</h3>
                                <button class="delete-btn text-xs text-red-400 hover:text-red-600" data-type="character" data-id="${char.id}">X</button>
                            </div>
                            <p class="text-sm text-muted font-semibold">${char.special_trait}</p>
                            <div class="mt-2 space-y-1">
                                <label class="text-xs font-bold text-muted">IDENTIDADES</label>
                                <input type="text" value="${char.identities.join(', ')}" class="w-full card-light p-1 rounded-md text-sm border-none focus:ring-2 focus:ring-primary" data-id="${char.id}" data-type="character" data-prop="identities">
                                <label class="text-xs font-bold text-muted">DESCRITORES</label>
                                <input type="text" value="${char.descriptors.join(', ')}" class="w-full card-light p-1 rounded-md text-sm border-none focus:ring-2 focus:ring-primary" data-id="${char.id}" data-type="character" data-prop="descriptors">
                            </div>
                            <textarea class="w-full card-light p-2 mt-2 rounded-md text-sm border-none focus:ring-2 focus:ring-primary" placeholder="Anotações..." data-id="${char.id}" data-type="character" data-prop="notes">${char.notes}</textarea>
                        </div>
                    </div>
                `).join('');
        }

        function renderPlotlines() {
            DOM.plotlineList.innerHTML = state.plotlines.length === 0
                ? `<li class="p-4 text-center text-muted">Nenhum enredo.</li>`
                : state.plotlines.map(plot => `
                    <li class="p-3 cursor-pointer border-b border-color last:border-b-0 hover:bg-surface-light transition-colors ${plot.id === activeSelections.plotlineId ? 'selected text-white' : ''}" data-id="${plot.id}">
                        ${plot.name}
                    </li>
                `).join('');
        }

        function renderTurningPoints() {
            DOM.tpList.innerHTML = state.turning_points.length === 0
                ? `<li class="p-4 text-center text-muted">Nenhum ponto de virada.</li>`
                : state.turning_points.map(tp => `
                    <li class="p-3 cursor-pointer border-b border-color last:border-b-0 hover:bg-surface-light transition-colors ${tp.id === activeSelections.tpId ? 'selected text-white' : ''}" data-id="${tp.id}">
                        ${tp.title}
                    </li>
                `).join('');
        }
        
        function renderPlotlineEditor() {
            const editor = DOM.plotlineEditor;
            const plot = state.plotlines.find(p => p.id === activeSelections.plotlineId);
            if (!plot) {
                editor.classList.remove('active');
                editor.innerHTML = '';
                return;
            }
            editor.innerHTML = `
                <h3 class="text-xl font-title mb-4">Editor de Linha de Enredo</h3>
                <div>
                    <label for="plot-name-input" class="block text-sm font-medium text-muted mb-1">Nome Curto</label>
                    <input type="text" id="plot-name-input" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary" value="${plot.name}">
                </div>
                <div class="mt-4">
                    <label for="plot-fulldesc-input" class="block text-sm font-medium text-muted mb-1">Descrição Completa</label>
                    <textarea id="plot-fulldesc-input" rows="3" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary">${plot.full_description}</textarea>
                </div>
                <div class="mt-4">
                    <label for="plot-notes-input" class="block text-sm font-medium text-muted mb-1">Anotações</label>
                    <textarea id="plot-notes-input" rows="5" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary">${plot.notes}</textarea>
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="delete-plotline-btn" class="px-4 py-2 rounded-md text-white btn-danger">Remover</button>
                    <button id="save-plotline-btn" class="px-4 py-2 rounded-md text-white btn-primary">Salvar</button>
                </div>
            `;
            editor.classList.add('active');
        }

        function renderTPEditor() {
            const editor = DOM.tpEditor;
            const tp = state.turning_points.find(t => t.id === activeSelections.tpId);
            if (!tp) {
                editor.classList.remove('active');
                editor.innerHTML = '';
                return;
            }
            const plotlineOptions = '<option value="">Nenhuma</option>' + state.plotlines.map(p => `<option value="${p.id}" ${p.id === tp.plotlineId ? 'selected' : ''}>${p.name}</option>`).join('');
            editor.innerHTML = `
                <h3 class="text-xl font-title mb-4">Editor de Ponto de Virada</h3>
                <div class="space-y-4">
                    <div>
                        <label for="tp-title-input" class="block text-sm font-medium text-muted mb-1">Título</label>
                        <input type="text" id="tp-title-input" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary" value="${tp.title}">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="tp-plotline-select" class="block text-sm font-medium text-muted mb-1">Linha de Enredo</label>
                            <select id="tp-plotline-select" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary">${plotlineOptions}</select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-muted mb-1">Status</label>
                            <div class="flex space-x-4 p-2">
                               <label><input type="radio" name="tp-status" value="Nova" ${tp.status === 'Nova' ? 'checked' : ''}> Nova</label>
                               <label><input type="radio" name="tp-status" value="Desenvolvimento" ${tp.status === 'Desenvolvimento' ? 'checked' : ''}> Em Andamento</label>
                               <label><input type="radio" name="tp-status" value="Conclusão" ${tp.status === 'Conclusão' ? 'checked' : ''}> Conclusão</label>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-muted">Pontos de Trama</label>
                            ${Array.from({length: 5}).map((_, i) => `<input type="text" class="tp-plot-point-input w-full p-2 rounded-md card-light border-none text-sm" placeholder="${i + 1}. ..." value="${tp.plot_points[i] || ''}">`).join('')}
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-muted">Personagens Invocados</label>
                            ${Array.from({length: 5}).map((_, i) => `<input type="text" class="tp-char-input w-full p-2 rounded-md card-light border-none text-sm" placeholder="${i + 1}. ..." value="${tp.invoked_characters[i] || ''}">`).join('')}
                        </div>
                    </div>
                    <div>
                        <label for="tp-notes-input" class="block text-sm font-medium text-muted mb-1">Anotações</label>
                        <textarea id="tp-notes-input" rows="4" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary">${tp.notes}</textarea>
                    </div>
                </div>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="delete-tp-btn" class="px-4 py-2 rounded-md text-white btn-danger">Remover</button>
                    <button id="save-tp-btn" class="px-4 py-2 rounded-md text-white btn-primary">Salvar</button>
                </div>
            `;
            editor.classList.add('active');
        }

        function renderHistory() {
            DOM.historyLog.value = state.history;
            DOM.historyLog.scrollTop = DOM.historyLog.scrollHeight;
        }

        // --- Lógica dos Modais e Geradores ---
        const modal = {
            content: document.getElementById('modal-content'),
            backdrop: document.getElementById('modal-backdrop'),
            container: document.getElementById('modal'),
            open(html) { this.content.innerHTML = html; this.backdrop.classList.remove('hidden'); this.container.classList.remove('hidden'); },
            close() { this.container.classList.add('hidden'); this.backdrop.classList.add('hidden'); this.content.innerHTML = ''; }
        };

        function showCharacterGenerator() {
            const nameThemes = Object.keys(charactersData.name_parts).map(t => `<option value="${t}">${t}</option>`).join('');
            modal.open(`
                <h2 class="font-title text-2xl mb-6 text-center">Gerador de Personagem</h2>
                <div class="space-y-4" id="char-gen-form">
                    <input type="text" id="char-name-input" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary" placeholder="Nome do Personagem">
                    <select id="char-name-theme" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary">${nameThemes}</select>
                    <button id="generate-char-name-btn" class="w-full py-2 rounded-md text-white font-semibold btn-primary">Gerar Nome</button>
                    <div class="p-4 rounded-md card-light space-y-2">
                        <p><b>Característica:</b> <span id="char-gen-special">...</span></p>
                        <div class="flex items-center"><b>Identidades:</b> <span id="char-gen-identities" class="ml-2">...</span><button class="reroll-btn ml-auto" data-type="identities">🎲</button></div>
                        <div class="flex items-center"><b>Descritores:</b> <span id="char-gen-descriptors" class="ml-2">...</span><button class="reroll-btn ml-auto" data-type="descriptors">🎲</button></div>
                    </div>
                    <button id="generate-char-attrs-btn" class="w-full py-2 rounded-md text-white font-semibold btn-accent">Gerar Atributos</button>
                </div>
                <div class="flex justify-end space-x-3 mt-8">
                    <button class="cancel-modal-btn px-4 py-2 rounded-md card-light">Cancelar</button>
                    <button id="confirm-add-char-btn" class="px-4 py-2 rounded-md text-white btn-accent">Adicionar Personagem</button>
                </div>
            `);
        }

        function showPlotlineGenerator() {
            const plotThemes = Object.keys(plotlinesData).map(t => `<option value="${t}">${t}</option>`).join('');
            modal.open(`
                <h2 class="font-title text-2xl mb-6 text-center">Gerador de Linha de Enredo</h2>
                <div class="space-y-4">
                     <select id="plot-theme" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary">${plotThemes}</select>
                    <button id="generate-plot-desc-btn" class="w-full py-2 rounded-md text-white font-semibold btn-primary">Gerar Descrição</button>
                    <p id="generated-plot-desc" class="text-center p-4 card-light rounded-md min-h-[60px]">...</p>
                    <input type="text" id="plot-name-modal-input" class="w-full p-2 rounded-md card-light border-none focus:ring-2 focus:ring-primary" placeholder="Dê um nome curto para o enredo">
                </div>
                <div class="flex justify-end space-x-3 mt-8">
                    <button class="cancel-modal-btn px-4 py-2 rounded-md card-light">Cancelar</button>
                    <button id="confirm-add-plot-btn" class="px-4 py-2 rounded-md text-white btn-accent">Adicionar Enredo</button>
                </div>
            `);
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.getElementById('tab-navigation').addEventListener('click', (e) => {
                if (e.target.matches('.tab-button')) {
                    const tabId = e.target.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                }
            });

            document.getElementById('generate-plot-point-btn').addEventListener('click', () => {
                let theme = document.getElementById('theme-select').value;
                let roll = rollDie(100);
                let originalRoll = roll;
                let originalTheme = theme;
                let phraseData = getPhraseByRoll(phrasesData[theme], roll);
                
                let finalTheme = theme;
                let metaInfo = "";

                if (phraseData && phraseData.title === "META") {
                    finalTheme = 'meta';
                    roll = rollDie(100);
                    phraseData = getPhraseByRoll(phrasesData.meta, roll);
                    metaInfo = ` (META! d100=${originalRoll} -> d100=${roll})`;
                }
                
                if (phraseData) {
                    logEvent(`Ponto Gerado (${originalTheme.toUpperCase()}): ${phraseData.title}${metaInfo}`);
                    const resultDisplay = document.getElementById('result-display');
                    const resultContent = document.getElementById('result-content');
                    
                    resultDisplay.style.backgroundColor = THEME_COLORS[finalTheme] || THEME_COLORS.default;
                    
                    resultContent.innerHTML = `<h3 id="result-title" class="text-2xl font-title mb-2">${THEME_EMOJIS[finalTheme] || ''} ${phraseData.title}</h3><p id="result-explanation" class="text-muted">${phraseData.desc}</p>`;
                } else {
                    document.getElementById('result-title').textContent = "Erro";
                    document.getElementById('result-explanation').textContent = `Nenhum resultado encontrado para o tema '${theme}' com a rolagem ${roll}.`;
                }
            });
            
            document.getElementById('add-character-btn').addEventListener('click', showCharacterGenerator);
            document.getElementById('add-plotline-btn').addEventListener('click', showPlotlineGenerator);
            document.getElementById('add-tp-btn').addEventListener('click', () => {
                const newTP = { id: Date.now(), title: `Novo Ponto de Virada ${state.turning_points.length + 1}`, plotlineId: null, status: 'Nova', plot_points: [], invoked_characters: [], notes: '' };
                state.turning_points.push(newTP);
                activeSelections.tpId = newTP.id;
                logEvent(`Ponto de Virada "${newTP.title}" criado.`);
                renderAll();
            });

            DOM.plotlineList.addEventListener('click', (e) => {
                if (e.target.matches('li')) { activeSelections.plotlineId = parseInt(e.target.dataset.id); renderAll(); }
            });
            DOM.tpList.addEventListener('click', (e) => {
                if (e.target.matches('li')) { activeSelections.tpId = parseInt(e.target.dataset.id); renderAll(); }
            });
            
            document.getElementById('app-container').addEventListener('click', (e) => {
                const plotEditor = e.target.closest('#plotline-editor-panel');
                if (plotEditor) {
                    if (e.target.matches('#save-plotline-btn')) {
                        const plot = state.plotlines.find(p => p.id === activeSelections.plotlineId);
                        if(plot) {
                            plot.name = plotEditor.querySelector('#plot-name-input').value;
                            plot.full_description = plotEditor.querySelector('#plot-fulldesc-input').value;
                            plot.notes = plotEditor.querySelector('#plot-notes-input').value;
                            logEvent(`Linha de enredo "${plot.name}" salva.`);
                            renderPlotlines();
                            showToast("Linha de enredo salva!");
                        }
                    } else if (e.target.matches('#delete-plotline-btn')) {
                        const plotName = state.plotlines.find(p => p.id === activeSelections.plotlineId)?.name;
                        state.plotlines = state.plotlines.filter(p => p.id !== activeSelections.plotlineId);
                        state.turning_points.forEach(tp => { if (tp.plotlineId === activeSelections.plotlineId) tp.plotlineId = null; });
                        activeSelections.plotlineId = null;
                        logEvent(`Linha de enredo "${plotName}" removida.`);
                        renderAll();
                    }
                }
                const tpEditor = e.target.closest('#tp-editor-panel');
                if (tpEditor) {
                    if(e.target.matches('#save-tp-btn')) {
                        const tp = state.turning_points.find(t => t.id === activeSelections.tpId);
                        if(tp) {
                            tp.title = tpEditor.querySelector('#tp-title-input').value;
                            tp.plotlineId = parseInt(tpEditor.querySelector('#tp-plotline-select').value) || null;
                            tp.status = tpEditor.querySelector('input[name="tp-status"]:checked').value;
                            tp.plot_points = Array.from(tpEditor.querySelectorAll('.tp-plot-point-input')).map(i => i.value);
                            tp.invoked_characters = Array.from(tpEditor.querySelectorAll('.tp-char-input')).map(i => i.value);
                            tp.notes = tpEditor.querySelector('#tp-notes-input').value;
                            logEvent(`Ponto de Virada "${tp.title}" salvo.`);
                            renderTurningPoints();
                            showToast("Ponto de virada salvo!");
                        }
                    } else if (e.target.matches('#delete-tp-btn')) {
                        const tpTitle = state.turning_points.find(t => t.id === activeSelections.tpId)?.title;
                        state.turning_points = state.turning_points.filter(t => t.id !== activeSelections.tpId);
                        activeSelections.tpId = null;
                        logEvent(`Ponto de Virada "${tpTitle}" removido.`);
                        renderAll();
                    }
                }
                if (e.target.matches('.delete-btn[data-type="character"]')) {
                    const charName = state.characters.find(c => c.id === parseInt(e.target.dataset.id))?.name;
                    state.characters = state.characters.filter(c => c.id !== parseInt(e.target.dataset.id));
                    logEvent(`Personagem "${charName}" removido.`);
                    renderCharacters();
                }
            });
            
            document.getElementById('app-container').addEventListener('input', (e) => {
                if (e.target.matches('textarea[data-type="character"], input[data-type="character"]')) {
                    const char = state.characters.find(c => c.id === parseInt(e.target.dataset.id));
                    if (!char) return;
                    const prop = e.target.dataset.prop;
                    if (prop === 'notes') {
                        char.notes = e.target.value;
                    } else if (prop === 'identities' || prop === 'descriptors') {
                        char[prop] = e.target.value.split(',').map(s => s.trim()).filter(Boolean);
                    }
                }
            });

            document.getElementById('modal').addEventListener('click', (e) => {
                const form = document.getElementById('char-gen-form');
                if (e.target.matches('.cancel-modal-btn')) modal.close();
                if (e.target.matches('#generate-char-attrs-btn') || e.target.matches('.reroll-btn')) {
                    const isReroll = e.target.matches('.reroll-btn');
                    const data = JSON.parse(form.dataset.generated || '{}');
                    if (!isReroll || !data.special_trait) {
                        const [special_trait, emoji] = getPhraseByRoll(charactersData.special_characteristics, rollDie(100));
                        data.special_trait = special_trait;
                        data.emoji = emoji;
                        document.getElementById('char-gen-special').textContent = `${special_trait} ${emoji}`;
                    }
                    if (!isReroll || e.target.dataset.type === 'identities') {
                        const num = rollDie(100) <= 33 ? 2 : 1;
                        data.identities = Array.from({ length: num }, () => shufflers.characters.identities.next());
                        document.getElementById('char-gen-identities').textContent = data.identities.join(', ');
                    }
                    if (!isReroll || e.target.dataset.type === 'descriptors') {
                        const num = rollDie(100) <= 21 ? 2 : 1;
                        data.descriptors = Array.from({ length: num }, () => shufflers.characters.descriptors.next());
                        document.getElementById('char-gen-descriptors').textContent = data.descriptors.join(', ');
                    }
                    form.dataset.generated = JSON.stringify(data);
                }
                if (e.target.matches('#generate-char-name-btn')) {
                    const theme = document.getElementById('char-name-theme').value;
                    const [firstNameShuffler, lastNameShuffler] = shufflers.characters.name_parts[theme];
                    let name = `${firstNameShuffler.next()} ${lastNameShuffler.next()}`;
                    if (theme === "Ficção Científica" && rollDie(100) <= 20) name = `${firstNameShuffler.next()}${lastNameShuffler.next()}-${rollDie(899) + 100}`;
                    document.getElementById('char-name-input').value = name;
                }
                if (e.target.matches('#confirm-add-char-btn')) {
                    const name = document.getElementById('char-name-input').value;
                    if (!name) { showToast("Por favor, insira um nome."); return; }
                    const data = JSON.parse(form.dataset.generated || '{}');
                    const newChar = { 
                        id: Date.now(), name, notes: '',
                        special_trait: data.special_trait || 'Não gerado',
                        emoji: data.emoji || '👤',
                        identities: data.identities || [],
                        descriptors: data.descriptors || [],
                    };
                    state.characters.push(newChar);
                    logEvent(`Personagem "${name}" criado.`);
                    renderCharacters();
                    modal.close();
                }
                if (e.target.matches('#generate-plot-desc-btn')) {
                    const theme = document.getElementById('plot-theme').value;
                    const { goals, subjects, focuses } = shufflers.plotlines[theme];
                    const desc = `${goals.next()} ${subjects.next()} ${focuses.next()}.`;
                    document.getElementById('generated-plot-desc').textContent = desc;
                    document.getElementById('confirm-add-plot-btn').dataset.description = desc;
                }
                if (e.target.matches('#confirm-add-plot-btn')) {
                    const name = document.getElementById('plot-name-modal-input').value;
                    const desc = e.target.dataset.description || 'Adicionado manualmente.';
                    if (!name) { showToast("Por favor, dê um nome para o enredo."); return; }
                    const newPlot = { id: Date.now(), name, full_description: desc, notes: '' };
                    state.plotlines.push(newPlot);
                    logEvent(`Linha de enredo "${name}" criada.`);
                    renderAll();
                    modal.close();
                }
            });
            
            document.getElementById('save-btn').addEventListener('click', () => {
                const dataStr = JSON.stringify(state, null, 2);
                const link = document.createElement('a');
                link.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                link.download = `adventure-crafter-${new Date().toISOString().slice(0,10)}.json`;
                link.click();
                logEvent(`Aventura salva.`);
            });
            document.getElementById('load-file').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const loaded = JSON.parse(ev.target.result);
                        if ('characters' in loaded && 'plotlines' in loaded && 'turning_points' in loaded) {
                            state = loaded;
                            initializeShufflers();
                            renderAll();
                            logEvent(`Aventura carregada do arquivo: ${file.name}`);
                            showToast("Aventura carregada!");
                        } else throw new Error("Formato de arquivo inválido.");
                    } catch (err) { showToast(`Erro ao carregar: ${err.message}`); }
                };
                reader.readAsText(file);
                e.target.value = '';
            });
            document.getElementById('theme-switcher').addEventListener('click', () => {
                document.body.classList.toggle('light-theme');
                const isLight = document.body.classList.contains('light-theme');
                state.theme = isLight ? 'light' : 'dark';
                document.getElementById('theme-icon-dark').classList.toggle('hidden', isLight);
                document.getElementById('theme-icon-light').classList.toggle('hidden', !isLight);
            });
            document.getElementById('modal-close-btn').addEventListener('click', modal.close);
            modal.backdrop.addEventListener('click', modal.close);
            document.getElementById('export-notes-btn').addEventListener('click', () => {
                const blob = new Blob([state.history], {type: 'text/plain'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `anotacoes-aventura-${new Date().toISOString().slice(0,10)}.txt`;
                link.click();
                URL.revokeObjectURL(link.href);
            });
            document.getElementById('clear-notes-btn').addEventListener('click', () => {
                if(confirm("Tem certeza que deseja limpar todo o registro de anotações?")) {
                    state.history = "";
                    renderHistory();
                    logEvent("Registro de anotações limpo.");
                }
            });
        }

        // --- Inicialização da Aplicação ---
        function init() {
            const themeSelect = document.getElementById('theme-select');
            themeSelect.innerHTML = Object.keys(phrasesData).map(t => `<option value="${t}">${t.charAt(0).toUpperCase() + t.slice(1)}</option>`).join('');
            
            initializeShufflers();
            setupEventListeners();
            renderAll();
            logEvent("Adventure Crafter iniciado.");
        }

        init();
    });
    </script>
</body>
</html>
